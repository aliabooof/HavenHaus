<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="../js/load_db.js"></script>
    <script type="module">
        import {GetCartByID, GetProductByID, ChangeCartItemQuantity,RemoveCartItem} from "../js/db.js"
        import {GetUrlField, IncreaseQuantity as IncQ, DecreaseQuantity as DecQ, redirect} from "../js/util.js"
        let cartID = GetUrlField("id")
        let totalPrice = {};
        if(!cartID) redirect("./not-found.html");
        function UpdateItemTotalPrice(prodID,price,quantity){
            totalPrice[prodID] = price * quantity
            let newTotalPrice = Object.values(totalPrice).reduce((acc, val) => acc + val, 0).toFixed(2);
            document.getElementById("subtotal").innerText = newTotalPrice
            document.getElementById("total-price").innerText = newTotalPrice
        }
        function DecreaseQuantity(event){
            let card = event.target.closest(".card")
            let prodID = card.dataset.prodId
            let prodPrice =  card.dataset.prodPrice
            // console.log(cartID,prodID)
            
            DecQ(event)
            let quantity = Number(event.target.nextElementSibling.innerText.trim())
            ChangeCartItemQuantity(cartID, prodID, quantity)

            UpdateItemTotalPrice(prodID,prodPrice,quantity)
        }
        function IncreaseQuantity(event){
            let card = event.target.closest(".card")
            let prodID = card.dataset.prodId
            let prodPrice =  card.dataset.prodPrice

            IncQ(event)
            let quantity = Number(event.target.previousElementSibling.innerText.trim())
            ChangeCartItemQuantity(cartID, prodID, quantity)

            UpdateItemTotalPrice(prodID,prodPrice,quantity)
        }
        
        let cart = GetCartByID(cartID)

        let itemsContainer;
        function DeleteCard(event){
            let prodID = event.target.closest(".card").dataset.prodId
            document.querySelector(`[data-prod-id="${prodID}"]`).remove()
            RemoveCartItem(cartID, prodID)
            
        }

        function CreateDisplyCartItem(cartItem){
            let product = GetProductByID(cartItem.productID)[0];
            totalPrice[product.id] =  cartItem.quantity * product.price;
            let cartString = `<div class="card mb-3" data-prod-id="${product.id}" data-prod-price="${product.price}">
                                    <div class="row g-0 align-items-center">
                                        <div class="col-4">
                                            <img src="../assets/images/banner.jpeg" class="img-fluid rounded-start" alt="Product">
                                        </div>
                                        <div class="col-8">
                                            <div class="card-body">
                                                <h5 class="card-title mb-1">${product.name}</h5>
                                                <p class="card-text text-muted mb-2">${product.desc}</p>
                                                <p class="card-text fw-bold text-primary">
                                                    <span class="fas fa-dollar-sign"></span>${product.price}
                                                </p>

                                                <div class="d-flex align-items-center" data-card-prod-id="${product.id}">
                                                    <button class="decreaseQuantityBtn btn btn-outline-secondary btn-sm me-2">âˆ’</button>
                                                    <span class ="quantity">${cartItem.quantity}</span>
                                                    <button class="increaseQuantityBtn btn btn-outline-secondary btn-sm ms-2">+</button>
                                                    <button class="delete-card-btn bi bi-trash btn btn-link text-danger ms-auto" ">
                                                    </button>
                                                    <span class="d-none stock">${product.stock}</span>
                                                </div>
                                                <div> <span class="small">Stock: ${product.stock}</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                `
            const parser = new DOMParser();
            let cartDiv = parser.parseFromString(cartString, 'text/html');
            cartDiv = cartDiv.body.firstElementChild;
            cartDiv.querySelector(".increaseQuantityBtn").addEventListener("click",IncreaseQuantity)
            cartDiv.querySelector(".decreaseQuantityBtn").addEventListener("click",DecreaseQuantity)
            cartDiv.querySelector(".delete-card-btn").addEventListener("click",DeleteCard)
            return cartDiv;
        }
        // console.log(cart)
        function DispalyCartItems(){
            cart.forEach(cartItem => {
                itemsContainer.appendChild( CreateDisplyCartItem(cartItem) )
            });
        }


        window.addEventListener("load",function(event){
                itemsContainer = document.getElementById("items-container");
                DispalyCartItems();
                let price = Object.values(totalPrice).reduce((acc, val) => acc + val, 0).toFixed(2);
                document.getElementById("subtotal").innerText = price
                document.getElementById("total-price").innerText = price
            })
    </script>
</head>

<body>

    <!-- Start of the Code -->
    <div class="container bg-gray p-4 rounded-4 shadow-sm">
        <div class="row">
            <h2 class="mb-4 fw-bold">Shopping Cart</h2>
            <!-- Products in your cart -->
            <div id="items-container" class="col-lg-8 col-12 mb-4">
                <!-- Cart Items Added here -->
                
            </div>
            <!-- Order Summary -->
            <div class="col-lg-4 col-12">
                <div class="card p-4 shadow-sm rounded-4">
                    <h4 class="mb-4 fw-bold">Order Details</h4>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal</span>
                        <span>$<span id="subtotal">0.0</span></span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Shipping</span>
                        <span class="text-success">Free</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <strong>Total</strong>
                        <strong>$<span id="total-price">0.0</span></strong>
                    </div>
                    <button class="btn btn-primary w-100 rounded-pill">Checkout</button>
                </div>
                <div class="text-center mt-4">
                    <a href="../index.html" class="btn btn-secondary">Continue Shopping</a>
                </div>
            </div>
        </div>
    </div>
    <!-- End of the Code -->

</body>

</html>